<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Refurbished Apple ‚Äî Viewer</title>
<style>
  :root{
    --bg:#f6f7f9; --card:#ffffff; --muted:#6b7280; --accent:#0070c9; --success:#10b981; --warning:#f59e0b;
    --radius:12px; --gap:14px; --pad:14px; font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
  }
  html,body{height:100%; margin:0; background:var(--bg); color:#111827;}
  .wrap{max-width:1400px; margin:24px auto; padding:18px;}
  header{display:flex; gap:12px; align-items:flex-start; margin-bottom:18px; flex-wrap:wrap;}
  .logo{font-weight:700; font-size:20px; color:var(--accent);}
  .controls{display:flex; flex-direction:column; gap:12px; flex:1; min-width:300px;}
  .filter-row{display:flex; gap:8px; align-items:center; flex-wrap:wrap;}
  input[type="search"], select{padding:10px 12px; border-radius:10px; border:1px solid #e5e7eb; background:white; font-size:14px; min-width:120px;}
  input[type="search"]{flex:1; min-width:200px;}
  .filter-group{display:flex; gap:8px; align-items:center; flex-wrap:wrap;}
  .filter-label{font-size:13px; font-weight:500; color:var(--muted); white-space:nowrap;}
  .stats{display:flex; gap:16px; align-items:center; font-size:13px; color:var(--muted); flex-wrap:wrap;}
  .stat{display:flex; align-items:center; gap:4px;}
  .grid{display:grid; grid-template-columns:repeat(auto-fill,minmax(280px,1fr)); gap:16px; margin-top:20px;}
  .card{background:var(--card); border-radius:var(--radius); padding:14px; box-shadow:0 2px 4px rgba(0,0,0,0.05); display:flex; flex-direction:column; gap:10px; min-height:260px; border:1px solid #f3f4f6; transition:all 0.2s ease;}
  .card:hover{box-shadow:0 4px 12px rgba(0,0,0,0.08); border-color:#e5e7eb;}
  .thumb{height:160px; border-radius:8px; overflow:hidden; display:flex; align-items:center; justify-content:center; background:#f9fafb;}
  .thumb img{max-width:100%; max-height:100%; object-fit:contain; display:block;}
  .title{font-size:15px; font-weight:600; line-height:1.3; color:#111827;}
  .category{display:inline-block; padding:2px 8px; border-radius:4px; font-size:11px; font-weight:500; text-transform:uppercase; letter-spacing:0.5px;}
  .category.laptop{background:#dbeafe; color:#1e40af;}
  .category.desktop{background:#dcfce7; color:#166534;}
  .category.ipad{background:#fef3c7; color:#92400e;}
  .category.iphone{background:#fce7f3; color:#be185d;}
  .category.watch{background:#f3e8ff; color:#7c3aed;}
  .category.airpods{background:#ecfdf5; color:#059669;}
  .category.accessory{background:#f1f5f9; color:#475569;}
  .category.other{background:#f3f4f6; color:#6b7280;}
  .meta{font-size:13px; color:var(--muted); display:flex; align-items:center; gap:8px; flex-wrap:wrap;}
  .spec-chip{display:inline-block; padding:2px 6px; background:#f8fafc; border:1px solid #e2e8f0; border-radius:4px; font-size:11px; font-weight:500; color:#475569;}
  .price{color:var(--accent); font-weight:700; font-size:16px;}
  .price-currency{font-size:13px; color:var(--muted); font-weight:400;}
  a.source{font-size:13px; color:var(--accent); text-decoration:none; font-weight:500;}
  a.source:hover{text-decoration:underline;}
  .uploader{border:1px dashed #d1d5db; padding:12px; border-radius:10px; background:linear-gradient(180deg,#fff, #fbfdff);}
  .small{font-size:13px; color:var(--muted);}
  .hidden{display:none;}
  .noitems{padding:40px; text-align:center; color:var(--muted);}
  .clear-filters{background:#f3f4f6; color:#6b7280; border:1px solid #d1d5db; padding:6px 12px; border-radius:6px; font-size:12px; cursor:pointer; transition:all 0.2s;}
  .clear-filters:hover{background:#e5e7eb;}
  .active-filters{display:flex; gap:6px; flex-wrap:wrap; align-items:center;}
  .filter-tag{background:var(--accent); color:white; padding:2px 8px; border-radius:12px; font-size:12px; display:flex; align-items:center; gap:4px;}
  .filter-tag .remove{cursor:pointer; font-weight:bold; opacity:0.7;}
  .filter-tag .remove:hover{opacity:1;}
  footer{margin-top:24px; padding-top:16px; border-top:1px solid #e5e7eb; font-size:13px; color:var(--muted);}
  .loading{display:flex; align-items:center; gap:8px; color:var(--muted); font-size:14px;}
  .spinner{width:16px; height:16px; border:2px solid #e5e7eb; border-top:2px solid var(--accent); border-radius:50%; animation:spin 1s linear infinite;}
  @keyframes spin{0%{transform:rotate(0deg)} 100%{transform:rotate(360deg)}}
  @media (max-width:768px){ 
    .thumb{height:140px} 
    .filter-row{flex-direction:column; align-items:stretch;}
    .filter-group{justify-content:flex-start;}
    .stats{justify-content:center;}
    .grid{grid-template-columns:1fr;}
  }
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="logo">üçé Refurbs Viewer</div>
    <div class="controls">
      <div class="filter-row">
        <select id="countrySelect" title="Choose country">
          <option value="">Loading...</option>
        </select>
        <input id="search" type="search" placeholder="Search title, specs, details..." />
        <button class="clear-filters" id="clearFilters" title="Clear all filters">Clear</button>
      </div>
      
      <div class="filter-row">
        <div class="filter-group">
          <span class="filter-label">Category:</span>
          <select id="categoryFilter"><option value="">All categories</option></select>
        </div>
        <div class="filter-group">
          <span class="filter-label">Chip:</span>
          <select id="chipFilter"><option value="">Any chip</option></select>
        </div>
        <div class="filter-group">
          <span class="filter-label">RAM:</span>
          <select id="ramFilter"><option value="">Any RAM</option></select>
        </div>
        <div class="filter-group">
          <span class="filter-label">Storage:</span>
          <select id="storageFilter"><option value="">Any storage</option></select>
        </div>
        <div class="filter-group">
          <span class="filter-label">Sort:</span>
          <select id="sortBy">
            <option value="relevance">Relevance</option>
            <option value="price_asc">Price ‚Üë</option>
            <option value="price_desc">Price ‚Üì</option>
            <option value="title">Name A-Z</option>
            <option value="category">Category</option>
          </select>
        </div>
      </div>
      
      <div class="active-filters" id="activeFilters"></div>
      
      <div class="stats" id="stats"></div>
    </div>
    
    <div class="uploader small" id="uploader" style="display:none">
      <div><strong>Local JSON load</strong> ‚Äî select the `refurbs_by_country_playwright.json` file if automatic load failed.</div>
      <input type="file" id="fileInput" accept=".json" />
    </div>
  </header>

  <main>
    <div id="message" class="small"></div>
    <div class="loading" id="loading" style="display:none;">
      <div class="spinner"></div>
      <span>Loading products...</span>
    </div>
    <div class="grid" id="grid"></div>
    <div id="noItems" class="noitems hidden">
      <div style="font-size:18px; margin-bottom:8px;">üîç No items found</div>
      <div>Try adjusting your filters or search terms</div>
    </div>
  </main>

  <footer>
    <div><strong>Tips:</strong> Use search to find specific models or specs. Filters are dynamically populated from available data. If loading fails with file:// URLs, run <code>python -m http.server</code> and visit <code>http://localhost:8000</code></div>
  </footer>
</div>

<script>
(function(){
  // DOM elements
  const GRID = document.getElementById('grid');
  const countrySelect = document.getElementById('countrySelect');
  const searchInput = document.getElementById('search');
  const categoryFilter = document.getElementById('categoryFilter');
  const chipFilter = document.getElementById('chipFilter');
  const ramFilter = document.getElementById('ramFilter');
  const storageFilter = document.getElementById('storageFilter');
  const sortBy = document.getElementById('sortBy');
  const fileInput = document.getElementById('fileInput');
  const uploader = document.getElementById('uploader');
  const msg = document.getElementById('message');
  const noItems = document.getElementById('noItems');
  const stats = document.getElementById('stats');
  const activeFilters = document.getElementById('activeFilters');
  const clearFilters = document.getElementById('clearFilters');
  const loading = document.getElementById('loading');

  // State
  let DATA = null;
  let currentCountry = null;
  let filters = {
    search: '',
    category: '',
    chip: '',
    ram: '',
    storage: ''
  };
  let debounceTimer = null;
  let uniqueValues = {
    categories: new Set(),
    chips: new Set(),
    rams: new Set(),
    storages: new Set()
  };

  function setMessage(t, type = 'info'){
    msg.innerHTML = t || '';
    msg.className = `small ${type}`;
  }

  function showLoading(show = true) {
    loading.style.display = show ? 'flex' : 'none';
  }

  async function attemptFetch(){
    try {
      showLoading(true);
      setMessage('Fetching data...');
      const resp = await fetch('refurbs_by_country_playwright.json');
      if (!resp.ok) throw new Error('HTTP ' + resp.status);
      const json = await resp.json();
      useData(json);
      setMessage('‚úì Data loaded successfully', 'success');
      uploader.style.display='none';
    } catch (err) {
      console.warn('fetch failed:', err);
      setMessage('‚ö† Could not fetch JSON automatically. Use the file picker below or run a local HTTP server.', 'warning');
      uploader.style.display='block';
    } finally {
      showLoading(false);
    }
  }

  function extractUniqueValues(items) {
    uniqueValues = {
      categories: new Set(),
      chips: new Set(),
      rams: new Set(),
      storages: new Set()
    };

    items.forEach(item => {
      if (item.category) uniqueValues.categories.add(item.category);
      if (item.chip) uniqueValues.chips.add(item.chip);
      if (item.ram) uniqueValues.rams.add(item.ram);
      if (item.storage) uniqueValues.storages.add(item.storage);
    });
  }

  function naturalSort(a, b) {
    return a.localeCompare(b, undefined, { numeric: true, sensitivity: 'base' });
  }

  function sortByCapacity(values, type) {
    return [...values].sort((a, b) => {
      if (type === 'ram' || type === 'storage') {
        // Extract numbers for size-based sorting
        const aNum = parseInt(a.match(/\d+/)?.[0] || '0');
        const bNum = parseInt(b.match(/\d+/)?.[0] || '0');
        return aNum - bNum;
      }
      return naturalSort(a, b);
    });
  }

  function populateFilters(){
    const allItems = Object.values(DATA || {}).flat().filter(Boolean);
    extractUniqueValues(allItems);

    // Populate category filter
    const categoryOptions = ['<option value="">All categories</option>']
      .concat([...uniqueValues.categories].sort().map(v => 
        `<option value="${escapeHtml(v)}">${escapeHtml(v)}</option>`
      ));
    categoryFilter.innerHTML = categoryOptions.join('');

    // Populate chip filter with smart sorting
    const chipOptions = ['<option value="">Any chip</option>']
      .concat(sortByCapacity(uniqueValues.chips, 'chip').map(v => 
        `<option value="${escapeHtml(v)}">${escapeHtml(v)}</option>`
      ));
    chipFilter.innerHTML = chipOptions.join('');

    // Populate RAM filter with capacity sorting
    const ramOptions = ['<option value="">Any RAM</option>']
      .concat(sortByCapacity(uniqueValues.rams, 'ram').map(v => 
        `<option value="${escapeHtml(v)}">${escapeHtml(v)}</option>`
      ));
    ramFilter.innerHTML = ramOptions.join('');

    // Populate storage filter with capacity sorting
    const storageOptions = ['<option value="">Any storage</option>']
      .concat(sortByCapacity(uniqueValues.storages, 'storage').map(v => 
        `<option value="${escapeHtml(v)}">${escapeHtml(v)}</option>`
      ));
    storageFilter.innerHTML = storageOptions.join('');
  }

  function useData(json){
    DATA = json;
    const countries = Object.keys(DATA).sort();
    const countryOptions = countries.map(c => 
      `<option value="${c}">${c} (${(DATA[c]?.length||0).toLocaleString()})</option>`
    );
    countrySelect.innerHTML = countryOptions.join('');
    
    currentCountry = countries[0];
    if (currentCountry) {
      countrySelect.value = currentCountry;
    }
    
    populateFilters();
    updateStats();
    render();
  }

  function escapeHtml(s){ 
    return String(s || '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); 
  }

  function formatPrice(p, cur){
    if (p === null || p === undefined || Number.isNaN(Number(p))) return '';
    try {
      const formatted = Number(p).toLocaleString(undefined, {minimumFractionDigits:0, maximumFractionDigits:2});
      return `<span class="price">${formatted}</span> <span class="price-currency">${cur || ''}</span>`;
    } catch(e){
      return `<span class="price">${p}</span> <span class="price-currency">${cur || ''}</span>`;
    }
  }

  function getCategoryClass(category) {
    return (category || 'other').toLowerCase().replace(/\s+/g, '');
  }

  function matches(item){
    if (!item) return false;
    
    // Search filter
    if (filters.search) {
      const searchTerms = filters.search.toLowerCase().split(/\s+/);
      const haystack = [
        item.title, item.chip, item.ram, item.storage, 
        item.category, item.additional_details
      ].filter(Boolean).join(' ').toLowerCase();
      
      if (!searchTerms.every(term => haystack.includes(term))) return false;
    }
    
    // Specific filters
    if (filters.category && item.category !== filters.category) return false;
    if (filters.chip && item.chip !== filters.chip) return false;
    if (filters.ram && item.ram !== filters.ram) return false;
    if (filters.storage && item.storage !== filters.storage) return false;
    
    return true;
  }

  function getItemsForCountry(country){
    if (!DATA || !country) return [];
    return (DATA[country] || []).filter(Boolean);
  }

  function updateActiveFilters() {
    const activeFiltersList = [];
    
    if (filters.search) activeFiltersList.push({key: 'search', label: `Search: "${filters.search}"`});
    if (filters.category) activeFiltersList.push({key: 'category', label: `Category: ${filters.category}`});
    if (filters.chip) activeFiltersList.push({key: 'chip', label: `Chip: ${filters.chip}`});
    if (filters.ram) activeFiltersList.push({key: 'ram', label: `RAM: ${filters.ram}`});
    if (filters.storage) activeFiltersList.push({key: 'storage', label: `Storage: ${filters.storage}`});

    if (activeFiltersList.length === 0) {
      activeFilters.innerHTML = '';
      return;
    }

    activeFilters.innerHTML = activeFiltersList.map(filter => 
      `<div class="filter-tag">
        ${escapeHtml(filter.label)}
        <span class="remove" data-filter="${filter.key}">√ó</span>
      </div>`
    ).join('');
  }

  function updateStats() {
    if (!DATA || !currentCountry) {
      stats.innerHTML = '';
      return;
    }

    const allItems = getItemsForCountry(currentCountry);
    const filteredItems = allItems.filter(matches);
    const totalProducts = allItems.length;
    const visibleProducts = filteredItems.length;

    // Count by category
    const categoryStats = {};
    filteredItems.forEach(item => {
      const cat = item.category || 'Other';
      categoryStats[cat] = (categoryStats[cat] || 0) + 1;
    });

    const categoryText = Object.entries(categoryStats)
      .sort(([,a], [,b]) => b - a)
      .slice(0, 3)
      .map(([cat, count]) => `${cat}: ${count}`)
      .join(', ');

    stats.innerHTML = `
      <div class="stat">üìä Showing ${visibleProducts.toLocaleString()} of ${totalProducts.toLocaleString()}</div>
      ${categoryText ? `<div class="stat">üì± ${categoryText}</div>` : ''}
    `;
  }

  function render(){
    if (!DATA || !currentCountry){ 
      GRID.innerHTML=''; 
      updateStats();
      return; 
    }

    const items = getItemsForCountry(currentCountry).filter(matches);
    
    updateActiveFilters();
    updateStats();
    
    if (!items.length){
      GRID.innerHTML='';
      noItems.classList.remove('hidden');
      return;
    }
    
    noItems.classList.add('hidden');
    
    // Sort items
    const sorted = items.slice();
    const sb = sortBy.value;
    
    if (sb === 'price_asc'){
      sorted.sort((a,b) => (Number(a.price) || Infinity) - (Number(b.price) || Infinity));
    } else if (sb === 'price_desc'){
      sorted.sort((a,b) => (Number(b.price) || -Infinity) - (Number(a.price) || -Infinity));
    } else if (sb === 'title'){
      sorted.sort((a,b) => naturalSort(a.title || '', b.title || ''));
    } else if (sb === 'category'){
      sorted.sort((a,b) => {
        const catCompare = naturalSort(a.category || 'ZZZ', b.category || 'ZZZ');
        return catCompare !== 0 ? catCompare : naturalSort(a.title || '', b.title || '');
      });
    }
    // relevance = original order (no sorting)

    GRID.innerHTML = sorted.map(p => {
      const title = escapeHtml(p.title || '‚Äî');
      const category = p.category || 'Other';
      const categoryClass = getCategoryClass(category);
      
      const img = p.image ? 
        `<img loading="lazy" src="${escapeHtml(p.image)}" alt="${title}">` : 
        `<div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;color:#9ca3af;font-size:14px;">No image</div>`;
      
      const specs = [p.chip, p.ram, p.storage].filter(Boolean);
      const specsHtml = specs.map(spec => `<span class="spec-chip">${escapeHtml(spec)}</span>`).join(' ');
      
      const price = formatPrice(p.price, p.currency);
      const url = p.source_url ? 
        `<a class="source" href="${escapeHtml(p.source_url)}" target="_blank" rel="noopener">View on Apple Store ‚Üí</a>` : '';
      
      const details = (p.additional_details || '').trim();
      const shortDetails = details.length > 150 ? details.slice(0, 150) + '‚Ä¶' : details;

      return `
        <article class="card" role="article">
          <div class="thumb">${img}</div>
          <div style="flex: 1; display: flex; flex-direction: column; gap: 8px;">
            <div style="display: flex; align-items: flex-start; gap: 8px; justify-content: space-between;">
              <div class="title" style="flex: 1;">${title}</div>
              <span class="category ${categoryClass}">${escapeHtml(category)}</span>
            </div>
            
            <div class="meta">
              ${specsHtml}
            </div>
            
            <div class="meta">
              ${price}
            </div>
            
            ${shortDetails ? `<div class="small" style="color: #6b7280; line-height: 1.4;">${escapeHtml(shortDetails)}</div>` : ''}
            
            <div style="margin-top: auto;">
              ${url}
            </div>
          </div>
        </article>
      `;
    }).join('');
  }

  function clearAllFilters() {
    filters = { search: '', category: '', chip: '', ram: '', storage: '' };
    searchInput.value = '';
    categoryFilter.value = '';
    chipFilter.value = '';
    ramFilter.value = '';
    storageFilter.value = '';
    render();
  }

  function removeFilter(filterKey) {
    filters[filterKey] = '';
    
    // Update corresponding UI element
    switch(filterKey) {
      case 'search': searchInput.value = ''; break;
      case 'category': categoryFilter.value = ''; break;
      case 'chip': chipFilter.value = ''; break;
      case 'ram': ramFilter.value = ''; break;
      case 'storage': storageFilter.value = ''; break;
    }
    
    render();
  }

  // Event listeners
  countrySelect.addEventListener('change', e => {
    currentCountry = e.target.value;
    populateFilters(); // Refresh filters for new country
    render();
  });

  categoryFilter.addEventListener('change', e => {
    filters.category = e.target.value;
    render();
  });

  chipFilter.addEventListener('change', e => {
    filters.chip = e.target.value;
    render();
  });

  ramFilter.addEventListener('change', e => {
    filters.ram = e.target.value;
    render();
  });

  storageFilter.addEventListener('change', e => {
    filters.storage = e.target.value;
    render();
  });

  sortBy.addEventListener('change', render);

  searchInput.addEventListener('input', e => {
    filters.search = e.target.value.trim();
    if (debounceTimer) clearTimeout(debounceTimer);
    debounceTimer = setTimeout(render, 300);
  });

  clearFilters.addEventListener('click', clearAllFilters);

  activeFilters.addEventListener('click', e => {
    if (e.target.classList.contains('remove')) {
      const filterKey = e.target.getAttribute('data-filter');
      removeFilter(filterKey);
    }
  });

  fileInput.addEventListener('change', e => {
    const f = e.target.files && e.target.files[0];
    if (!f) return;
    
    showLoading(true);
    setMessage('Loading file...');
    
    const r = new FileReader();
    r.onload = function(ev){
      try {
        const json = JSON.parse(ev.target.result);
        useData(json);
        setMessage('‚úì File loaded successfully', 'success');
        uploader.style.display='none';
      } catch(err){
        setMessage('‚ùå Error parsing JSON: ' + err.message, 'error');
      } finally {
        showLoading(false);
      }
    };
    r.readAsText(f, 'utf-8');
  });

  // Initialize
  attemptFetch();

  // Debug helpers
  window.__REFURBS = { 
    useData, render, clearAllFilters,
    getData: () => DATA, 
    getFilters: () => filters,
    getStats: () => uniqueValues
  };
})();
</script>
</body>
</html>